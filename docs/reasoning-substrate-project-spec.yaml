# yaml-language-server: $schema=project-spec-schema
version: "1.0"
metadata:
  source_document: "reasoning-substrate-workbook-audited__2_.md"
  product_name: "Reasoning Substrate"
  tagline: "The Codebase Consciousness Platform"
  generated_at: "2025-12-19T00:00:00Z"
  total_effort_days: 48
  estimated_duration_weeks: "7-10"
  critical_path:
    - "task-1.4-github-app-setup"
    - "task-1.7-installation-flow"
    - "task-2.4-ingest-job"
    - "task-2.7-git-history"
    - "task-2.10-pr-history"
    - "task-3.4-extract-job"
    - "task-3.16-filesystem-tree"
    - "task-3.10-confidence-tier"
    - "task-3.13-violation-module"
    - "task-4.9-backtest"
    - "task-4.4-promote-action"
    - "task-5a.3-pattern-transformer"
    - "task-5b.1-webhook-endpoint"
    - "task-5b.3-code-violation"
    - "task-5b.5-evolution-detect"
    - "task-5b.9-pr-comments"

epics:
  # ============================================
  # EPIC 1: FOUNDATION
  # ============================================
  - id: "epic-foundation"
    title: "Establish infrastructure, auth, and core data model"
    description: |
      Set up the foundational infrastructure including Hono backend (Bun runtime),
      Vite + TanStack Router frontend, Supabase for database and auth, Trigger.dev for
      background jobs, and GitHub App for repo integration. Uses tRPC for type-safe API calls.
      User should be able to log in, install the GitHub App, and see repos in an empty dashboard.
    prd_refs: ["Section 6.2 Phase 1", "D4", "D7", "D15", "D37"]
    effort_days: 5
    stories:
      - id: "story-project-setup"
        title: "Initialize project infrastructure"
        description: |
          Set up the monorepo structure with Hono backend, Vite frontend, Supabase,
          and Trigger.dev for background jobs. Includes tRPC for type-safe API calls.
        prd_refs: ["Task 1.1", "Task 1.2", "Task 1.3", "Task 1.10", "D37"]
        effort_hours: 10
        acceptance_criteria:
          - "Monorepo with apps/api (Hono) and apps/web (Vite) working"
          - "Supabase project created with Postgres database accessible via Drizzle ORM"
          - "Trigger.dev project connected to API app"
          - "tRPC router shared between frontend and backend"
          - "All environment variables documented in .env.example"
        tasks:
          - id: "task-1.1-monorepo-init"
            title: "Initialize monorepo with Hono backend and Vite frontend"
            description: |
              Create Turborepo monorepo with Bun workspaces. Set up apps/api (Hono)
              and apps/web (Vite + React + TanStack Router). Configure shared packages.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 1.1", "D37"]
            blocked_by: []
            related_to: []
            acceptance_criteria:
              - "Turborepo monorepo with Bun workspaces configured"
              - "apps/api with Hono running on port 3001"
              - "apps/web with Vite + TanStack Router running on port 3000"
              - "Basic health check endpoint responding at /api/health"
              - "TypeScript and Tailwind CSS v4 configured"
          - id: "task-1.2-supabase-setup"
            title: "Set up Supabase project with Postgres and Drizzle ORM"
            description: |
              Create Supabase project, configure database connection with Drizzle ORM,
              enable auth providers. Set up both API and web clients.
            type: "task"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 1.2", "D6", "D37"]
            blocked_by: []
            related_to: []
            acceptance_criteria:
              - "Supabase project created in production region"
              - "Database connection string available"
              - "Drizzle ORM configured with schema in apps/api/src/lib/db/"
              - "GitHub OAuth provider enabled in Supabase Auth"
          - id: "task-1.3-triggerdev-setup"
            title: "Set up Trigger.dev project and connect to API app"
            description: |
              Initialize Trigger.dev for background job processing. Configure connection
              to Hono API app.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 1.3", "D37"]
            blocked_by: ["task-1.1-monorepo-init"]
            related_to: []
            acceptance_criteria:
              - "Trigger.dev project created and linked to repo"
              - "Test job can be triggered and observed in dashboard"
              - "SDK configured in apps/api"
      - id: "story-github-app"
        title: "GitHub App setup and OAuth integration"
        description: |
          Create GitHub App for organization-level access, implement OAuth login flow,
          and app installation flow for repo selection.
        prd_refs: ["Task 1.4", "Task 1.5", "Task 1.7", "D4", "D15"]
        effort_hours: 16
        acceptance_criteria:
          - "GitHub App created with required permissions"
          - "User can log in via GitHub OAuth"
          - "User can install GitHub App and select repos"
          - "Installation ID stored for each connected repo"
        tasks:
          - id: "task-1.4-github-app-setup"
            title: "Create GitHub App with required permissions"
            description: |
              Create GitHub App in dev environment with permissions for repo read, 
              PR read/write, status checks, and webhooks.
            type: "task"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 1.4", "D4"]
            blocked_by: []
            related_to: []
            acceptance_criteria:
              - "GitHub App created with name 'Reasoning Substrate (Dev)'"
              - "Permissions: repo contents read, PRs read/write, status checks write"
              - "Webhook URL configured for PR events"
              - "Private key generated and stored securely"
          - id: "task-1.5-github-oauth"
            title: "Implement GitHub OAuth flow for user login"
            description: |
              Implement GitHub OAuth login using Supabase Auth. Store user profile in database.
            type: "feature"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 1.5", "D4"]
            blocked_by: ["task-1.2-supabase-setup", "task-1.4-github-app-setup"]
            related_to: []
            acceptance_criteria:
              - "User can click 'Sign in with GitHub' and complete OAuth flow"
              - "User record created in database with GitHub ID and username"
              - "Session persisted across page refreshes"
              - "Logout functionality works correctly"
          - id: "task-1.7-installation-flow"
            title: "Implement GitHub App installation flow with repo selection"
            description: |
              User can install the GitHub App on their org/account and select which repos to connect.
            type: "feature"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 1.7", "D4", "D5"]
            blocked_by: ["task-1.4-github-app-setup", "task-1.5-github-oauth"]
            related_to: ["task-1.8-installation-token"]
            acceptance_criteria:
              - "User can initiate GitHub App installation from dashboard"
              - "After installation, redirected back to app with installation_id"
              - "User can see and select from repos accessible to the installation"
              - "Selected repos stored in database linked to user"
      - id: "story-core-schema"
        title: "Design and implement core database schema"
        description: |
          Create database migrations for all core entities: users, repos, patterns, 
          violations, provenance, and supporting tables.
        prd_refs: ["Task 1.6", "Section 2.4", "D5", "D6"]
        effort_hours: 8
        acceptance_criteria:
          - "All core tables created with proper constraints and indexes"
          - "TypeScript types generated from schema"
          - "RLS policies configured for multi-tenant access"
          - "Foreign key relationships properly defined"
        tasks:
          - id: "task-1.6-core-schema"
            title: "Create core database schema and migrations"
            description: |
              Implement database schema for users, repos, patterns, pattern_evidence, 
              filesystem_pattern_evidence, provenance, pull_requests, violations, 
              backtest_violations, pattern_evolution_requests, context_file_configs, repo_files.
            type: "task"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 1.6", "Section 2.4"]
            blocked_by: ["task-1.2-supabase-setup"]
            related_to: []
            acceptance_criteria:
              - "All tables from Section 2.4 created"
              - "JSONB columns for confidenceScore, healthSignals, backtestSummary"
              - "CASCADE deletes configured (pattern → backtest_violations)"
              - "Indexes on frequently queried columns (repoId, status, patternId)"
          - id: "task-1.8-installation-token"
            title: "Implement on-demand GitHub token generation utility"
            description: |
              Create utility function getInstallationToken(installationId) using @octokit/auth-app.
              Store installation ID in Repo record (not tokens).
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 1.8", "D15"]
            blocked_by: ["task-1.6-core-schema", "task-1.7-installation-flow"]
            related_to: []
            acceptance_criteria:
              - "getInstallationToken function returns valid token"
              - "Token automatically refreshed before expiry by @octokit/auth-app"
              - "Installation ID stored in repos table"
              - "No tokens stored in database"
          - id: "task-1.9-env-config"
            title: "Configure environment variables across all services"
            description: |
              Set up GITHUB_APP_ID, GITHUB_APP_PRIVATE_KEY, GITHUB_WEBHOOK_SECRET
              and document in .env.example files for API and web apps.
            type: "task"
            priority: 0
            effort_hours: 1
            prd_refs: ["Task 1.9", "D15", "D37"]
            blocked_by: ["task-1.4-github-app-setup"]
            related_to: []
            acceptance_criteria:
              - "All required env vars documented in .env.example files"
              - "apps/api/.env.example for backend vars"
              - "apps/web/.env.example for frontend vars (VITE_ prefix)"
              - "Trigger.dev environment variables configured"
              - "Local development working with .env files"
  # ============================================
  # EPIC 2: INGESTION
  # ============================================
  - id: "epic-ingestion"
    title: "Build codebase ingestion pipeline with git metadata"
    description: |
      Fetch and index repository content, extract git history for confidence scoring,
      and fetch historical PRs for backtest. Includes file tree UI and progress tracking.
    prd_refs: ["Section 6.2 Phase 2", "D9", "D10", "D11", "D28"]
    effort_days: 5
    stories:
      - id: "story-repo-fetch"
        title: "Repository content fetching and indexing"
        description: |
          Clone or fetch repository content via GitHub API, build file tree index,
          and store metadata for analysis.
        prd_refs: ["Task 2.1", "Task 2.2", "Task 2.3", "Task 2.5"]
        effort_hours: 12
        acceptance_criteria:
          - "Repository content accessible for analysis"
          - "File tree with metadata stored in database"
          - "Content chunking strategy implemented"
        tasks:
          - id: "task-2.1-repo-fetch"
            title: "Implement repo content fetching via GitHub API"
            description: |
              Fetch repository contents using GitHub API. Handle rate limiting and pagination.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 2.1"]
            blocked_by: ["task-1.8-installation-token"]
            related_to: []
            acceptance_criteria:
              - "Can fetch file list for any accessible repository"
              - "Can fetch individual file contents"
              - "Rate limiting handled with exponential backoff"
              - "Respects X-RateLimit-Remaining header"
          - id: "task-2.2-file-tree-indexer"
            title: "Build file tree indexer with metadata"
            description: |
              Catalog all files with metadata: path, language, size. Filter out binaries and 
              irrelevant files (node_modules, etc.).
            type: "task"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 2.2"]
            blocked_by: ["task-2.1-repo-fetch"]
            related_to: ["task-2.12-token-count"]
            acceptance_criteria:
              - "File tree indexed with path, language detection, size"
              - "Binary files and irrelevant paths excluded"
              - "Language detection working for common languages"
          - id: "task-2.3-content-chunking"
            title: "Implement content chunking strategy"
            description: |
              Implement file-level chunking for extraction. Prepare content for LLM context.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 2.3", "D10"]
            blocked_by: ["task-2.2-file-tree-indexer"]
            related_to: []
            acceptance_criteria:
              - "File contents prepared for LLM context"
              - "Format includes file path and content"
              - "Token estimation available per file"
          - id: "task-2.4-ingest-job"
            title: "Create Trigger.dev ingestRepo job"
            description: |
              Background job that orchestrates full ingestion: fetch files, index tree, 
              fetch git history, fetch PR history, calculate tokens.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 2.4"]
            blocked_by: ["task-1.3-triggerdev-setup", "task-2.1-repo-fetch", "task-2.2-file-tree-indexer", "task-2.3-content-chunking"]
            related_to: ["task-2.11-progress-tracking"]
            acceptance_criteria:
              - "Job triggered when repo is connected"
              - "Updates ingestionStatus through pending → ingesting → ingested/failed"
              - "All sub-tasks (file tree, git history, PRs) executed in order"
              - "Errors captured and stored in Repo.lastError"
          - id: "task-2.5-store-indexed-content"
            title: "Store indexed content and file references"
            description: |
              Store file tree in database with references to content. Enable retrieval for extraction.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 2.5"]
            blocked_by: ["task-2.4-ingest-job"]
            related_to: []
            acceptance_criteria:
              - "File tree stored in database linked to repo"
              - "Content accessible for extraction phase"
      - id: "story-git-metadata"
        title: "Git history and PR metadata collection"
        description: |
          Fetch git commit history for confidence scoring (author attribution, pattern age),
          and historical PRs for backtest functionality.
        prd_refs: ["Task 2.7", "Task 2.8", "Task 2.9", "Task 2.10", "D11", "D28"]
        effort_hours: 12
        acceptance_criteria:
          - "2-year git commit history available per file"
          - "Author username and commit date extractable via blame"
          - "Recent merged PRs with diffs stored for backtest"
        tasks:
          - id: "task-2.7-git-history"
            title: "Fetch git commit history (2-year depth)"
            description: |
              Retrieve commit history via GitHub Commits API for confidence scoring.
            type: "task"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 2.7", "D11"]
            blocked_by: ["task-2.1-repo-fetch"]
            related_to: ["task-2.8-git-blame"]
            acceptance_criteria:
              - "Commit history retrieved for past 2 years"
              - "Author, date, and SHA available per commit"
              - "Rate limiting handled appropriately"
          - id: "task-2.8-git-blame"
            title: "Extract per-file author metadata via git blame"
            description: |
              For each file, determine author username, commit date, and SHA. 
              For multi-line ranges, use startLine for deterministic attribution.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 2.8", "D11"]
            blocked_by: ["task-2.7-git-history"]
            related_to: []
            acceptance_criteria:
              - "Author username extracted per file"
              - "Commit date (pattern introduction time) available"
              - "Commit SHA available for GitHub links"
          - id: "task-2.9-file-metadata"
            title: "Store file metadata for extraction"
            description: |
              Store path, language, size for each indexed file. Location classification 
              moved to extraction phase (D25: LLM-based).
            type: "task"
            priority: 0
            effort_hours: 1
            prd_refs: ["Task 2.9", "D25"]
            blocked_by: ["task-2.2-file-tree-indexer"]
            related_to: []
            acceptance_criteria:
              - "File metadata stored with repo reference"
              - "Language and size available for filtering"
          - id: "task-2.10-pr-history"
            title: "Fetch recent merged PRs for backtest (D28)"
            description: |
              Fetch merged PRs from last 90 days, store diff content in Supabase Storage
              for backtest violation detection.
            type: "task"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 2.10", "D12", "D28"]
            blocked_by: ["task-2.1-repo-fetch"]
            related_to: ["task-4.9-backtest"]
            acceptance_criteria:
              - "Merged PRs from last 90 days fetched (cap at 100)"
              - "Diff content stored in Supabase Storage"
              - "PR metadata stored with diffStoragePath reference"
              - "Rate limiting handled with backoff"
      - id: "story-ingestion-ui"
        title: "Ingestion UI and progress tracking"
        description: |
          Build UI for repo file tree display, ingestion status, and real-time progress updates.
        prd_refs: ["Task 2.6", "Task 2.11", "Task 2.12", "Task 2.13", "Task 2.14"]
        effort_hours: 10
        acceptance_criteria:
          - "File tree visible in UI with repo metadata"
          - "Real-time progress updates during ingestion"
          - "Token count warning for oversized repos"
        tasks:
          - id: "task-2.6-file-tree-ui"
            title: "Build file tree and ingestion status UI"
            description: |
              Display repository file tree and ingestion status in the dashboard.
            type: "feature"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 2.6"]
            blocked_by: ["task-2.5-store-indexed-content"]
            related_to: []
            acceptance_criteria:
              - "File tree displayed in expandable tree view"
              - "Ingestion status shown (pending/ingesting/ingested/failed)"
              - "File count and basic stats visible"
          - id: "task-2.11-progress-tracking"
            title: "Implement ingestion progress tracking with Realtime"
            description: |
              Update Repo record with step status, use Supabase Realtime for live UI updates.
            type: "feature"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 2.11"]
            blocked_by: ["task-2.4-ingest-job"]
            related_to: []
            acceptance_criteria:
              - "Progress steps visible: files indexed, git history fetched, PRs fetched"
              - "Real-time updates via Supabase Realtime subscription"
              - "UI reflects current progress without refresh"
          - id: "task-2.12-token-count"
            title: "Calculate token count and enforce limit"
            description: |
              Estimate tokens during ingestion (0.25 tokens/char), block extraction if >600k.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 2.12", "D10"]
            blocked_by: ["task-2.2-file-tree-indexer"]
            related_to: ["task-3.4-extract-job"]
            acceptance_criteria:
              - "Token count calculated and stored in Repo.tokenCount"
              - "Repos exceeding 600k tokens marked as failed with reason"
              - "UI shows warning for oversized repos"
          - id: "task-2.13-repo-files-table"
            title: "Store indexed file paths for evidence autocomplete"
            description: |
              Populate repo_files table during ingestion for evidence management autocomplete.
            type: "task"
            priority: 1
            effort_hours: 1
            prd_refs: ["Task 2.13", "D21"]
            blocked_by: ["task-2.3-content-chunking"]
            related_to: ["task-4.13-evidence-management"]
            acceptance_criteria:
              - "All indexed file paths stored in repo_files table"
              - "Table updated on re-ingestion"
              - "Fast lookup available for autocomplete"
          - id: "task-2.14-stale-evidence-detection"
            title: "Mark evidence as stale during re-ingestion"
            description: |
              During re-ingestion, check if existing evidence file paths still exist in repo_files.
              Mark missing files as stale.
            type: "task"
            priority: 2
            effort_hours: 1
            prd_refs: ["Task 2.14", "D21"]
            blocked_by: ["task-2.13-repo-files-table"]
            related_to: []
            acceptance_criteria:
              - "Evidence for deleted files marked isStale=true"
              - "staleReason set to 'File deleted'"
              - "Stale evidence visible in UI with warning"
  # ============================================
  # EPIC 3: EXTRACTION
  # ============================================
  - id: "epic-extraction"
    title: "Implement LLM pattern extraction with confidence scoring"
    description: |
      Build the core extraction pipeline using Claude Sonnet 4.5 to identify patterns,
      compute multi-dimensional confidence scores, detect health signals, and prepare
      violation detection for backtest and enforcement.
    prd_refs: ["Section 6.2 Phase 3", "D8", "D10", "D11", "D20", "D23", "D24", "D25"]
    effort_days: 10
    stories:
      - id: "story-extraction-pipeline"
        title: "Core LLM extraction pipeline"
        description: |
          Design extraction prompts and implement the pipeline that analyzes repository
          content to identify recurring patterns.
        prd_refs: ["Task 3.1", "Task 3.2", "Task 3.3", "Task 3.4", "Task 3.5", "Task 3.6"]
        effort_hours: 24
        acceptance_criteria:
          - "Extraction prompt identifies patterns with their evidence locations"
          - "Patterns deduplicated and stored as candidates"
          - "Extraction job runs after ingestion completes"
        tasks:
          - id: "task-3.1-extraction-prompt"
            title: "Design extraction prompt strategy"
            description: |
              Define what constitutes a pattern and design the extraction prompt.
            type: "spike"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 3.1", "D8", "D13"]
            blocked_by: []
            related_to: ["task-3.2-extraction-pipeline"]
            acceptance_criteria:
              - "Clear definition of pattern types to extract"
              - "Prompt structure designed for consistent output"
              - "Output schema defined (JSON with name, description, evidence, type)"
          - id: "task-3.2-extraction-pipeline"
            title: "Implement LLM extraction pipeline with Claude Sonnet 4.5"
            description: |
              Build the extraction pipeline that sends repository content to Claude and 
              parses the response into pattern candidates.
            type: "feature"
            priority: 0
            effort_hours: 8
            prd_refs: ["Task 3.2", "D8", "D10"]
            blocked_by: ["task-2.5-store-indexed-content", "task-3.1-extraction-prompt"]
            related_to: []
            acceptance_criteria:
              - "Repository content sent to Claude Sonnet 4.5"
              - "Uses 1M context beta header"
              - "Response parsed into structured pattern candidates"
              - "Error handling for API failures and rate limits"
          - id: "task-3.3-pattern-schema"
            title: "Define pattern schema and evidence structure"
            description: |
              Finalize TypeScript types for Pattern and PatternEvidence matching DB schema.
            type: "task"
            priority: 0
            effort_hours: 1
            prd_refs: ["Task 3.3", "Section 2.4"]
            blocked_by: ["task-1.6-core-schema"]
            related_to: []
            acceptance_criteria:
              - "TypeScript types match database schema"
              - "Validation functions for pattern data"
          - id: "task-3.4-extract-job"
            title: "Create Trigger.dev extractPatterns job"
            description: |
              Background job that runs after ingestion, validates token count, 
              and orchestrates the full extraction pipeline.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 3.4", "D10"]
            blocked_by: ["task-1.3-triggerdev-setup", "task-3.2-extraction-pipeline", "task-2.12-token-count"]
            related_to: []
            acceptance_criteria:
              - "Job triggered after successful ingestion"
              - "Validates tokenCount < 600k before proceeding"
              - "Updates extractionStatus through pending → extracting → extracted/failed"
              - "Errors captured in Repo.lastError"
          - id: "task-3.5-pattern-dedup"
            title: "Deduplicate and merge similar patterns"
            description: |
              After extraction, merge patterns that are semantically similar to avoid duplicates.
            type: "task"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 3.5"]
            blocked_by: ["task-3.4-extract-job"]
            related_to: []
            acceptance_criteria:
              - "Similar patterns merged during extraction"
              - "Evidence from merged patterns combined"
              - "Deduplication logged for observability"
          - id: "task-3.6-store-candidates"
            title: "Store candidate patterns in database"
            description: |
              Persist extracted patterns with status='candidate' in the patterns table.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 3.6"]
            blocked_by: ["task-3.5-pattern-dedup"]
            related_to: []
            acceptance_criteria:
              - "Patterns stored with status='candidate'"
              - "Evidence stored in pattern_evidence table"
              - "extractedAt and extractedByModel populated"
      - id: "story-confidence-scoring"
        title: "Multi-dimensional confidence scoring system"
        description: |
          Compute confidence dimensions (Evidence, Adoption, Establishment, Location),
          derive tiers, and generate contextual insights.
        prd_refs: ["Task 3.7", "Task 3.8", "Task 3.9", "Task 3.10", "Task 3.11", "D11", "D20", "D23", "D24", "D25"]
        effort_hours: 20
        acceptance_criteria:
          - "All four confidence dimensions computed"
          - "Tier derived based on dimension thresholds"
          - "Health signals detected and stored"
          - "Contextual insight generated per pattern"
        tasks:
          - id: "task-3.7-confidence-dimensions"
            title: "Compute confidence dimensions from git metadata and LLM"
            description: |
              Calculate Evidence, Adoption, Establishment, and Location dimensions.
            type: "task"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 3.7", "D11", "D25"]
            blocked_by: ["task-2.8-git-blame", "task-3.6-store-candidates"]
            related_to: ["task-3.10-confidence-tier"]
            acceptance_criteria:
              - "Evidence: instanceCount and consistency from extraction"
              - "Adoption: uniqueAuthors from git blame data"
              - "Establishment: ageCategory from commit dates"
              - "Location: codeCategory per evidence file (LLM-classified)"
          - id: "task-3.8-consistency-assessment"
            title: "Request consistency assessment in extraction prompt"
            description: |
              Include consistency assessment rubric in extraction prompt; store per-pattern.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 3.8", "D20"]
            blocked_by: ["task-3.2-extraction-pipeline"]
            related_to: []
            acceptance_criteria:
              - "Extraction prompt includes consistency rubric"
              - "LLM returns consistency level (high/medium/low)"
              - "consistencyNote captured for UI display"
          - id: "task-3.9-health-signals"
            title: "Run health signals prompt per pattern"
            description: |
              Single prompt per pattern covering all 5 health signal categories.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 3.9", "D23"]
            blocked_by: ["task-3.6-store-candidates"]
            related_to: []
            acceptance_criteria:
              - "Health signals prompt covers all 5 categories"
              - "Results stored in Pattern.healthSignals JSONB"
              - "hasWarnings flag set for quick filtering"
          - id: "task-3.10-confidence-tier"
            title: "Derive confidence tier from dimensions"
            description: |
              Apply threshold logic to derive tier (strong/emerging/moderate/weak/legacy).
              Store full PatternConfidence object.
            type: "task"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 3.10", "D11"]
            blocked_by: ["task-3.7-confidence-dimensions", "task-3.8-consistency-assessment"]
            related_to: []
            acceptance_criteria:
              - "Tier derived according to D11 definitions"
              - "Full PatternConfidence stored in confidenceScore JSONB"
              - "Weak tier logic handles single author correctly"
          - id: "task-3.11-insight-generation"
            title: "Implement insight generation with json-rules-engine"
            description: |
              Use json-rules-engine to generate contextual insights based on pattern facts.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 3.11", "D24"]
            blocked_by: ["task-3.10-confidence-tier", "task-3.9-health-signals"]
            related_to: []
            acceptance_criteria:
              - "json-rules-engine installed and configured"
              - "15 starter rules implemented"
              - "Highest-priority matching insight returned per pattern"
      - id: "story-filesystem-extraction"
        title: "Filesystem pattern extraction"
        description: |
          Extract file-naming and file-structure conventions with 2-dimension confidence.
        prd_refs: ["Task 3.16", "Task 3.17", "Task 3.18", "Task 3.19", "D31", "D34"]
        effort_hours: 12
        acceptance_criteria:
          - "Directory structure analyzed for patterns"
          - "File-naming and file-structure patterns extracted"
          - "2-dimension confidence (Evidence + Adoption) computed"
        tasks:
          - id: "task-3.16-filesystem-tree"
            title: "File tree analysis for filesystem patterns"
            description: |
              Extract directory structure, file names, and path patterns for analysis.
            type: "task"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 3.16"]
            blocked_by: ["task-3.1-extraction-prompt"]
            related_to: ["task-3.17-filesystem-prompt"]
            acceptance_criteria:
              - "Directory structure extracted with depth"
              - "File names grouped by pattern"
              - "Path patterns identified"
          - id: "task-3.17-filesystem-prompt"
            title: "Filesystem pattern extraction prompt"
            description: |
              Design and implement prompt to identify file-naming and file-structure conventions.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 3.17", "D31"]
            blocked_by: ["task-3.16-filesystem-tree"]
            related_to: []
            acceptance_criteria:
              - "Prompt identifies file-naming patterns with glob patterns"
              - "Prompt identifies file-structure patterns with example paths"
              - "Anti-pattern examples extracted for context files"
          - id: "task-3.18-filesystem-evidence"
            title: "Store FilesystemPatternEvidence"
            description: |
              Store example paths, glob patterns, and anti-patterns for filesystem patterns.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 3.18"]
            blocked_by: ["task-3.17-filesystem-prompt"]
            related_to: []
            acceptance_criteria:
              - "FilesystemPatternEvidence records created per path"
              - "globPattern stored on Pattern for enforcement"
              - "antiPatternExamples stored on Pattern for context files"
          - id: "task-3.19-filesystem-confidence"
            title: "2-dimension confidence for filesystem patterns"
            description: |
              Compute simplified confidence (Evidence + Adoption) for filesystem patterns.
            type: "task"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 3.19", "D34"]
            blocked_by: ["task-3.18-filesystem-evidence"]
            related_to: []
            acceptance_criteria:
              - "Evidence dimension: path count demonstrating pattern"
              - "Adoption dimension: % of matching paths following convention"
              - "confidenceModel='filesystem' set on pattern"
      - id: "story-violation-module"
        title: "Shared violation detection module"
        description: |
          Build the core violation detection logic that compares patterns against diffs.
          Used by both backtest and live PR enforcement.
        prd_refs: ["Task 3.12", "Task 3.13", "Task 3.14", "Task 3.15"]
        effort_hours: 12
        acceptance_criteria:
          - "Violation detection works on pattern + diff input"
          - "Returns violations with file, line, description"
          - "Similarity detection flags duplicate candidates"
        tasks:
          - id: "task-3.12-candidate-list-ui"
            title: "Basic UI to list candidate patterns with confidence tiers"
            description: |
              Display extracted patterns with tier badges for initial validation.
            type: "feature"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 3.12"]
            blocked_by: ["task-3.11-insight-generation"]
            related_to: []
            acceptance_criteria:
              - "Patterns listed with name, type, tier badge"
              - "Sortable by tier and extraction date"
              - "Clickable to view details"
          - id: "task-3.13-violation-module"
            title: "Build violation detection module (pattern + diff → violations)"
            description: |
              Core module that analyzes a diff against a pattern to detect violations.
              Shared between backtest and PR enforcement.
            type: "feature"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 3.13"]
            blocked_by: ["task-3.6-store-candidates"]
            related_to: ["task-4.9-backtest", "task-5b.3-code-violation"]
            acceptance_criteria:
              - "Accepts pattern definition and diff content"
              - "Returns list of violations with file, line, description"
              - "Handles both code and file-naming patterns"
          - id: "task-3.14-extraction-progress"
            title: "Add extraction progress to Repo with Realtime events"
            description: |
              Update extractionStatus and emit Supabase Realtime events during extraction.
            type: "task"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 3.14"]
            blocked_by: ["task-3.4-extract-job"]
            related_to: ["task-4.12-repo-progress"]
            acceptance_criteria:
              - "extractionStatus updated: pending → extracting → extracted/failed"
              - "Supabase Realtime events emitted on status change"
              - "UI can subscribe for live updates"
          - id: "task-spike-time-to-value"
            title: "Validate <15min time-to-value is achievable"
            description: |
              Spike to measure and validate that users can see useful patterns
              within 15 minutes of connecting a repo. Critical hypothesis validation.
            type: "spike"
            priority: 1
            effort_hours: 4
            prd_refs: ["Q2", "H9", "R4"]
            blocked_by: ["task-3.4-extract-job"]
            related_to: ["task-4.12-repo-progress", "task-2.4-ingest-job"]
            acceptance_criteria:
              - "Time from repo connection to first pattern visible measured"
              - "Bottlenecks identified if >15min"
              - "Optimization recommendations documented if threshold exceeded"
              - "Go/no-go decision on current architecture documented"
          - id: "task-3.15-similarity-detection"
            title: "Duplicate detection for candidates vs authoritative patterns"
            description: |
              After extraction, detect candidates similar to existing authoritative patterns.
              Set similarToPatternId for merge action.
            type: "task"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 3.15", "D29"]
            blocked_by: ["task-3.6-store-candidates", "task-3.9-health-signals"]
            related_to: ["task-4.14-merge-action"]
            acceptance_criteria:
              - "Candidates compared against existing authoritative patterns"
              - "Similar patterns flagged with similarToPatternId"
              - "Bundled with health signals prompt for efficiency"
  # ============================================
  # EPIC 4: VALIDATION
  # ============================================
  - id: "epic-validation"
    title: "Build human validation workflow with backtest and queue UX"
    description: |
      Enable humans to review pattern candidates, promote to authoritative status with
      rationale and provenance, and see impact preview via backtest.
    prd_refs: ["Section 6.2 Phase 4", "D12", "D13", "D17", "D18", "D19", "D21", "D22", "D29"]
    effort_days: 9
    stories:
      - id: "story-pattern-cards"
        title: "Pattern confidence cards and triage queue"
        description: |
          Build the keyboard-driven triage queue with confidence cards, tier badges,
          health warnings, and backtest preview.
        prd_refs: ["Task 4.1", "Task 4.2", "Task 4.8", "Task 4.11", "D13", "D17"]
        effort_hours: 20
        acceptance_criteria:
          - "Pattern cards show all confidence dimensions"
          - "Queue sorted by tier with backtest tie-breaking"
          - "Keyboard navigation with j/k/p/r/d shortcuts"
        tasks:
          - id: "task-4.1-confidence-card"
            title: "Build pattern confidence card UI"
            description: |
              Display dimension bars, tier badge, health warnings, and insight.
            type: "feature"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 4.1", "D11", "D13"]
            blocked_by: ["task-3.12-candidate-list-ui"]
            related_to: []
            acceptance_criteria:
              - "Four dimension bars for code patterns (Evidence, Adoption, Establishment, Location)"
              - "Two dimension pills for filesystem patterns (Evidence, Adoption)"
              - "Tier badge with color coding"
              - "Health warnings with category icons"
              - "Contextual insight text and suggested actions"
          - id: "task-4.2-insight-display"
            title: "Display contextual insight and suggested actions"
            description: |
              Show the generated insight from rules engine with actionable suggestions.
            type: "feature"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 4.2"]
            blocked_by: ["task-3.11-insight-generation"]
            related_to: []
            acceptance_criteria:
              - "Insight text displayed prominently on card"
              - "Suggested actions shown as clickable buttons"
          - id: "task-4.8-pattern-dashboard"
            title: "Build pattern dashboard with filtering and sorting"
            description: |
              Full pattern dashboard with filters by status, tier, repo, type.
            type: "feature"
            priority: 1
            effort_hours: 6
            prd_refs: ["Task 4.8", "D17"]
            blocked_by: ["task-4.7-pattern-detail"]
            related_to: []
            acceptance_criteria:
              - "Filter by status (candidate, authoritative, rejected, deferred)"
              - "Filter by tier, repo, type"
              - "Sort by confidence score and extraction date"
          - id: "task-4.11-queue-ux"
            title: "Implement keyboard-driven triage queue"
            description: |
              Superhuman-style queue with j/k navigation, p/r/d shortcuts, progress bar.
            type: "feature"
            priority: 0
            effort_hours: 8
            prd_refs: ["Task 4.11", "D13", "D17"]
            blocked_by: ["task-4.8-pattern-dashboard"]
            related_to: []
            acceptance_criteria:
              - "j/k for next/previous pattern"
              - "p for Promote, r for Reject, d for Defer"
              - "Progress bar showing queue completion"
              - "Deferred patterns in separate section"
          - id: "task-4.15-filesystem-card"
            title: "Filesystem pattern card UI with 2 confidence pills"
            description: |
              Display filesystem patterns with appropriate 2-dimension confidence.
            type: "feature"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 4.15", "D34"]
            blocked_by: ["task-4.1-confidence-card"]
            related_to: []
            acceptance_criteria:
              - "2 confidence pills (Evidence, Adoption) for filesystem patterns"
              - "Path examples and glob pattern displayed"
              - "Type badge distinguishes file-naming vs file-structure"
      - id: "story-validation-actions"
        title: "Validation actions (Promote, Reject, Defer)"
        description: |
          Implement the three core validation actions with their respective workflows.
        prd_refs: ["Task 4.3", "Task 4.4", "Task 4.5", "Task 4.6", "D18", "D19", "D22"]
        effort_hours: 16
        acceptance_criteria:
          - "Promote action with modal, severity, rationale"
          - "Reject action with optional reason"
          - "Defer action instant with count tracking"
        tasks:
          - id: "task-4.3-validation-actions"
            title: "Implement Promote, Reject, Defer actions"
            description: |
              Core action handlers for all three validation workflows.
            type: "feature"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 4.3", "D18", "D19"]
            blocked_by: ["task-4.1-confidence-card"]
            related_to: []
            acceptance_criteria:
              - "Promote opens modal with configuration options"
              - "Reject opens modal with optional reason"
              - "Defer is instant, increments deferCount"
          - id: "task-4.4-promote-action"
            title: "Implement Promote action with ownership and severity"
            description: |
              On promote: set status='authoritative', ownerId, validatedBy, defaultSeverity.
            type: "feature"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 4.4", "D19", "D22"]
            blocked_by: ["task-4.3-validation-actions"]
            related_to: []
            acceptance_criteria:
              - "status changed to 'authoritative'"
              - "ownerId and validatedBy set to current user"
              - "defaultSeverity set from modal selection"
              - "statusChangedAt timestamp captured"
          - id: "task-4.5-rationale-field"
            title: "Add rationale field (the 'Why') on promote"
            description: |
              Free text field for human-provided reasoning captured during promotion.
            type: "feature"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 4.5", "D3"]
            blocked_by: ["task-4.4-promote-action"]
            related_to: []
            acceptance_criteria:
              - "Rationale text field in promote modal"
              - "Optional but encouraged"
              - "Stored in Pattern.rationale"
          - id: "task-4.6-provenance-linking"
            title: "Add provenance linking with URL input"
            description: |
              Allow users to link patterns to PRs, docs, Slack threads as decision history.
            type: "feature"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 4.6", "D3"]
            blocked_by: ["task-4.4-promote-action"]
            related_to: []
            acceptance_criteria:
              - "URL input field in promote modal"
              - "Type selection (PR, doc, Slack, etc.)"
              - "Provenance records created and linked to pattern"
          - id: "task-4.16-enforcement-toggles"
            title: "Enforcement channel toggles in promotion modal"
            description: |
              Add PR Review and AI Agents checkboxes with severity dropdown.
            type: "feature"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 4.16", "D30"]
            blocked_by: ["task-4.4-promote-action"]
            related_to: []
            acceptance_criteria:
              - "PR Review checkbox (default: true for code/file-naming)"
              - "AI Agents checkbox (default: true)"
              - "Severity dropdown for each enabled channel"
          - id: "task-4.17-disable-structure-pr"
            title: "Disable PR enforcement for file-structure patterns"
            description: |
              Show tooltip explaining why PR enforcement is not available for structure patterns.
            type: "task"
            priority: 2
            effort_hours: 1
            prd_refs: ["Task 4.17", "D35"]
            blocked_by: ["task-4.16-enforcement-toggles"]
            related_to: []
            acceptance_criteria:
              - "PR Review checkbox disabled for file-structure patterns"
              - "Tooltip: 'PR enforcement not available for structure patterns'"
      - id: "story-pattern-detail"
        title: "Pattern detail view and evidence management"
        description: |
          Full pattern detail page with edit capabilities and evidence management.
        prd_refs: ["Task 4.7", "Task 4.13", "D21"]
        effort_hours: 12
        acceptance_criteria:
          - "Full pattern detail with all metadata"
          - "Edit capabilities for description, rationale"
          - "Evidence management with add/remove/set canonical"
        tasks:
          - id: "task-4.7-pattern-detail"
            title: "Build pattern detail view"
            description: |
              Full pattern page with provenance, evidence, confidence breakdown.
            type: "feature"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 4.7", "D13"]
            blocked_by: ["task-4.4-promote-action", "task-4.5-rationale-field", "task-4.6-provenance-linking"]
            related_to: []
            acceptance_criteria:
              - "Pattern name, description, type, status displayed"
              - "Confidence breakdown with all dimensions"
              - "Evidence list with GitHub links"
              - "Provenance links displayed"
              - "Edit buttons for authoritative patterns"
          - id: "task-4.13-evidence-management"
            title: "Build evidence management UI with autocomplete"
            description: |
              Modal for adding, removing, and updating evidence with file path autocomplete.
            type: "feature"
            priority: 1
            effort_hours: 6
            prd_refs: ["Task 4.13", "D21"]
            blocked_by: ["task-4.7-pattern-detail", "task-2.13-repo-files-table"]
            related_to: []
            acceptance_criteria:
              - "Autocomplete from repo_files table"
              - "Validate path exists before adding"
              - "Optional line range input"
              - "Set/change canonical example"
              - "Remove evidence with confirmation for canonical"
              - "Stale evidence shown with warning badge"
      - id: "story-backtest"
        title: "Backtest and impact preview"
        description: |
          Run patterns against historical PRs to show potential impact.
        prd_refs: ["Task 4.9", "Task 4.10", "Task 4.10a", "D12"]
        effort_hours: 12
        acceptance_criteria:
          - "Backtest runs against historical PRs"
          - "Results stored in backtestSummary and backtest_violations"
          - "Impact preview shown in validation UI"
        tasks:
          - id: "task-4.9-backtest"
            title: "Run backtest against historical PRs"
            description: |
              For each candidate, detect violations across stored PR diffs.
            type: "feature"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 4.9", "D12", "D28"]
            blocked_by: ["task-3.13-violation-module", "task-2.10-pr-history"]
            related_to: []
            acceptance_criteria:
              - "Each candidate tested against historical PRs"
              - "Summary stored in Pattern.backtestSummary"
              - "Individual violations stored in backtest_violations table"
              - "CASCADE delete cleans up on pattern deletion"
          - id: "task-4.10-impact-preview"
            title: "Display impact preview in validation UI"
            description: |
              Show "Would have caught X violations in Y PRs" on pattern cards.
            type: "feature"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 4.10", "D12"]
            blocked_by: ["task-4.9-backtest"]
            related_to: []
            acceptance_criteria:
              - "Backtest results shown on pattern card"
              - "Violation count and PR count displayed"
              - "Click through to view details"
          - id: "task-4.10a-backtest-detail"
            title: "Build 'View all violations' modal for backtest results"
            description: |
              Modal or page listing all BacktestViolation records with PR links.
            type: "feature"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 4.10a"]
            blocked_by: ["task-4.9-backtest"]
            related_to: []
            acceptance_criteria:
              - "List all backtest violations for a pattern"
              - "Links to original PRs"
              - "File and line information displayed"
      - id: "story-merge-and-progress"
        title: "Merge action and real-time progress"
        description: |
          Handle duplicate candidates with merge action and show live repo progress.
        prd_refs: ["Task 4.12", "Task 4.14", "D29"]
        effort_hours: 6
        acceptance_criteria:
          - "Duplicate candidates show merge action"
          - "Real-time progress during ingestion/extraction"
        tasks:
          - id: "task-4.12-repo-progress"
            title: "Build repo progress page with Realtime updates"
            description: |
              Live progress during ingestion and extraction with pattern list animation.
            type: "feature"
            priority: 1
            effort_hours: 4
            prd_refs: ["Task 4.12"]
            blocked_by: ["task-2.11-progress-tracking", "task-3.14-extraction-progress"]
            related_to: []
            acceptance_criteria:
              - "Subscribe to repos UPDATE events"
              - "Subscribe to patterns INSERT events"
              - "Animate pattern list as extraction completes"
              - "Unsubscribe on unmount"
          - id: "task-4.14-merge-action"
            title: "Implement merge action for duplicate candidates"
            description: |
              One-click merge to transfer evidence from candidate to existing authoritative pattern.
            type: "feature"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 4.14", "D29"]
            blocked_by: ["task-4.3-validation-actions", "task-3.15-similarity-detection"]
            related_to: []
            acceptance_criteria:
              - "Duplicate card variant in queue"
              - "Merge action copies evidence to target pattern"
              - "Candidate deleted (cascades backtest_violations)"
              - "Success toast with evidence count"
  # ============================================
  # EPIC 5a: CONTEXT FILES
  # ============================================
  - id: "epic-context-files"
    title: "Generate AI agent context files from authoritative patterns"
    description: |
      Transform authoritative patterns into CLAUDE.md and .cursorrules formats
      with marker-based append and debounced sync.
    prd_refs: ["Section 6.2 Phase 5a", "D30", "D32", "D33", "D36"]
    effort_days: 5
    stories:
      - id: "story-context-generation"
        title: "Context file generation and sync"
        description: |
          Generate markdown context files from patterns with format adapters.
        prd_refs: ["Task 5a.1", "Task 5a.2", "Task 5a.3", "Task 5a.4", "Task 5a.5", "Task 5a.6", "Task 5a.7"]
        effort_hours: 28
        acceptance_criteria:
          - "Patterns transformed to structured markdown"
          - "Claude and Cursor format adapters working"
          - "Marker-based append preserves user content"
          - "Debounced sync on pattern changes"
        tasks:
          - id: "task-5a.1-context-config"
            title: "ContextFileConfig data model and API"
            description: |
              Store format, targetPath, syncEnabled per repo.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 5a.1", "D32"]
            blocked_by: ["task-2.1-repo-fetch"]
            related_to: []
            acceptance_criteria:
              - "ContextFileConfig table created"
              - "CRUD API for config"
              - "Default configs created on repo connection"
          - id: "task-5a.2-context-setup-ui"
            title: "Context file setup UI (Workflow 9)"
            description: |
              UI for selecting formats and customizing paths.
            type: "feature"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 5a.2"]
            blocked_by: ["task-5a.1-context-config", "task-4.1-confidence-card"]
            related_to: []
            acceptance_criteria:
              - "Format selection (Claude, Cursor)"
              - "Path customization"
              - "Sync toggle"
          - id: "task-5a.3-pattern-transformer"
            title: "Pattern → markdown transformer (base)"
            description: |
              Convert authoritative patterns to structured markdown.
            type: "feature"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 5a.3", "D30"]
            blocked_by: ["task-5a.1-context-config"]
            related_to: []
            acceptance_criteria:
              - "Patterns with aiContext=true included"
              - "Structured markdown with pattern name, description, rationale"
              - "Evidence references included"
          - id: "task-5a.4-format-adapters"
            title: "Format adapters for Claude and Cursor"
            description: |
              Adjust tone and structure for each tool's conventions.
            type: "task"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 5a.4", "D32"]
            blocked_by: ["task-5a.3-pattern-transformer"]
            related_to: []
            acceptance_criteria:
              - "Claude format: CLAUDE.md structure"
              - "Cursor format: .cursorrules structure"
              - "Tool-specific conventions respected"
          - id: "task-5a.5-filesystem-transformer"
            title: "Filesystem pattern → markdown transformer"
            description: |
              Convert file-naming and file-structure patterns for context files.
            type: "task"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 5a.5", "D31"]
            blocked_by: ["task-5a.3-pattern-transformer"]
            related_to: []
            acceptance_criteria:
              - "Filesystem patterns in dedicated section"
              - "Glob patterns shown for file-naming"
              - "Directory structure examples for file-structure"
          - id: "task-5a.6-marker-append"
            title: "Marker-based file append logic"
            description: |
              Detect existing markers and replace only managed section.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 5a.6", "D33"]
            blocked_by: ["task-5a.3-pattern-transformer"]
            related_to: []
            acceptance_criteria:
              - "Markers: <!-- REASONING_SUBSTRATE_START/END -->"
              - "User content outside markers preserved"
              - "New files created with just managed section"
              - "Existing files without markers: append at end"
          - id: "task-5a.7-debounced-sync"
            title: "Debounced sync trigger on pattern changes"
            description: |
              Trigger.dev job with 5-10s delay, batch accumulated changes.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 5a.7", "D36"]
            blocked_by: ["task-5a.3-pattern-transformer"]
            related_to: []
            acceptance_criteria:
              - "Pattern changes queue regeneration"
              - "5-10s debounce window"
              - "Batch multiple changes into single regeneration"
          - id: "task-5a.8-download-ui"
            title: "Manual download/copy UI for context files"
            description: |
              Allow users to download or copy generated content.
            type: "feature"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 5a.8"]
            blocked_by: ["task-5a.3-pattern-transformer"]
            related_to: []
            acceptance_criteria:
              - "Download generated file"
              - "Copy to clipboard"
              - "Preview in modal"
          - id: "task-5a.9-sync-dashboard"
            title: "AI Agent Sync dashboard widget (Workflow 10)"
            description: |
              Show sync status, last updated, pattern counts, regenerate button.
            type: "feature"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 5a.9"]
            blocked_by: ["task-5a.7-debounced-sync"]
            related_to: []
            acceptance_criteria:
              - "Sync status indicator (synced/pending/error)"
              - "Last updated timestamp"
              - "Pattern counts per format"
              - "Manual regenerate button"
  # ============================================
  # EPIC 5b: PR ENFORCEMENT
  # ============================================
  - id: "epic-pr-enforcement"
    title: "Implement PR analysis with violation comments and evolution detection"
    description: |
      Set up webhook endpoint for PR events, analyze diffs against authoritative patterns,
      post violation comments, create status checks, and handle pattern evolution.
    prd_refs: ["Section 6.2 Phase 5b", "D19", "D26", "D27", "D30"]
    effort_days: 7
    stories:
      - id: "story-pr-webhook"
        title: "GitHub webhook and PR analysis pipeline"
        description: |
          Set up webhook endpoint, verify signatures, and analyze PRs for violations.
        prd_refs: ["Task 5b.1", "Task 5b.2", "Task 5b.3", "Task 5b.4", "Task 5b.7", "Task 5b.8"]
        effort_hours: 24
        acceptance_criteria:
          - "Webhook endpoint receives and verifies PR events"
          - "Diff fetched and analyzed against patterns"
          - "Violations stored with pattern severity"
        tasks:
          - id: "task-5b.1-webhook-endpoint"
            title: "Set up GitHub webhook endpoint with signature verification"
            description: |
              Endpoint for PR events (opened, synchronize) with security verification.
            type: "feature"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 5b.1"]
            blocked_by: ["task-1.4-github-app-setup"]
            related_to: []
            acceptance_criteria:
              - "Endpoint at /api/github/webhook"
              - "Signature verified using @octokit/webhooks-methods"
              - "401 returned for invalid signatures"
              - "Rejected webhooks logged for security monitoring"
          - id: "task-5b.2-fetch-diff"
            title: "Fetch PR diff on webhook event"
            description: |
              Retrieve the diff for the PR being analyzed.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 5b.2"]
            blocked_by: ["task-5b.1-webhook-endpoint"]
            related_to: []
            acceptance_criteria:
              - "Diff fetched from GitHub API"
              - "Full diff content available for analysis"
          - id: "task-5b.3-code-violation"
            title: "Build code pattern violation detection for PRs"
            description: |
              Compare PR diff against authoritative patterns where prReview=true.
            type: "feature"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 5b.3", "D30"]
            blocked_by: ["task-3.13-violation-module", "task-5b.2-fetch-diff"]
            related_to: []
            acceptance_criteria:
              - "Only patterns with enforcement.prReview=true checked"
              - "Uses shared violation detection module"
              - "Returns violations with file, line, description"
          - id: "task-5b.4-file-naming-violation"
            title: "File naming violation detection via regex"
            description: |
              Match new file paths against file-naming pattern globs.
            type: "task"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 5b.4", "D35"]
            blocked_by: ["task-5b.1-webhook-endpoint"]
            related_to: []
            acceptance_criteria:
              - "New files checked against file-naming globs"
              - "Only patterns with enforcement.prReview=true"
              - "Violations created for non-matching files"
          - id: "task-5b.7-analyze-job"
            title: "Create Trigger.dev analyzePR job"
            description: |
              Background job that orchestrates PR analysis on webhook.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 5b.7"]
            blocked_by: ["task-1.3-triggerdev-setup", "task-5b.3-code-violation"]
            related_to: []
            acceptance_criteria:
              - "Job triggered on webhook"
              - "Updates analysisStatus through pending → analyzing → analyzed/failed"
              - "Errors captured in PullRequest.lastError"
          - id: "task-5b.8-store-violations"
            title: "Store violations with idempotency"
            description: |
              Store violations linked to PR and pattern with duplicate prevention.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 5b.8", "D19"]
            blocked_by: ["task-5b.7-analyze-job"]
            related_to: []
            acceptance_criteria:
              - "Violations stored with PR and pattern references"
              - "Severity inherited from pattern.defaultSeverity"
              - "Idempotent: check existing before insert"
      - id: "story-pr-comments"
        title: "PR comments and status checks"
        description: |
          Post inline comments for violations and update status checks.
        prd_refs: ["Task 5b.9", "Task 5b.10", "Task 5b.11", "Task 5b.12", "Task 5b.13"]
        effort_hours: 16
        acceptance_criteria:
          - "Inline comments posted for each violation"
          - "Status check updated based on severity"
          - "Pattern owner attribution in comments"
        tasks:
          - id: "task-5b.9-pr-comments"
            title: "Post inline PR comments for violations"
            description: |
              Post comments with pattern owner attribution and rationale snippet.
            type: "feature"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 5b.9", "D12"]
            blocked_by: ["task-5b.8-store-violations"]
            related_to: []
            acceptance_criteria:
              - "Inline comment posted at violation location"
              - "Pattern name and type shown"
              - "Owner attribution: 'Maintained by @username'"
              - "Rationale snippet included"
              - "Dismiss link to app"
          - id: "task-5b.10-evolution-comments"
            title: "Post pattern evolution PR comments"
            description: |
              Notify pattern owner when evidence is modified in PR.
            type: "feature"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 5b.10", "D27"]
            blocked_by: ["task-5b.6-diff-summary"]
            related_to: []
            acceptance_criteria:
              - "Comment when evidence file modified"
              - "Different format for canonical vs non-canonical"
              - "Diff summary included"
              - "Review link to app"
          - id: "task-5b.11-status-check"
            title: "Post GitHub status check based on violations"
            description: |
              Update commit status check based on violation severities.
            type: "feature"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 5b.11"]
            blocked_by: ["task-5b.8-store-violations"]
            related_to: []
            acceptance_criteria:
              - "Status check name: 'Reasoning Substrate'"
              - "Any error → failure"
              - "Warning only → success"
              - "None → success"
          - id: "task-5b.12-evolution-status"
            title: "Status check for pending evolution reviews"
            description: |
              Block merge for canonical modifications until reviewed.
            type: "feature"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 5b.12", "D27"]
            blocked_by: ["task-5b.5-evolution-detect"]
            related_to: []
            acceptance_criteria:
              - "Canonical modified → pending state"
              - "Description: 'Awaiting review: canonical example modified'"
              - "Non-canonical → success with note"
          - id: "task-5b.13-pr-history-ui"
            title: "Build PR analysis history UI"
            description: |
              Show PR analysis history and violations per PR.
            type: "feature"
            priority: 2
            effort_hours: 3
            prd_refs: ["Task 5b.13"]
            blocked_by: ["task-5b.8-store-violations"]
            related_to: []
            acceptance_criteria:
              - "List of analyzed PRs with status"
              - "Violation count per PR"
              - "Click through to PR details"
      - id: "story-evolution-workflow"
        title: "Pattern evolution detection and review"
        description: |
          Detect when PRs modify pattern evidence and enable owner review.
        prd_refs: ["Task 5b.5", "Task 5b.6", "Task 5b.14", "Task 5b.15", "D27"]
        effort_hours: 16
        acceptance_criteria:
          - "Evidence modifications detected in PRs"
          - "PatternEvolutionRequest created for each match"
          - "Owner can accept evolution or create violation"
        tasks:
          - id: "task-5b.5-evolution-detect"
            title: "Detect pattern evolution in PR diffs"
            description: |
              Check if diff modifies files that are evidence for authoritative patterns.
            type: "feature"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 5b.5", "D27"]
            blocked_by: ["task-5b.2-fetch-diff"]
            related_to: []
            acceptance_criteria:
              - "Changed files compared against evidence paths"
              - "PatternEvolutionRequest created for matches"
              - "isCanonical flag set appropriately"
          - id: "task-5b.6-diff-summary"
            title: "Generate diff summary for evolution requests"
            description: |
              Use LLM to summarize what changed in evidence files.
            type: "task"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 5b.6", "D27"]
            blocked_by: ["task-5b.5-evolution-detect"]
            related_to: []
            acceptance_criteria:
              - "LLM generates concise diff summary"
              - "Stored in PatternEvolutionRequest"
          - id: "task-5b.14-violation-detail"
            title: "Build violation detail page with dismiss action"
            description: |
              Page for viewing and dismissing violations from PR comment links.
            type: "feature"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 5b.14", "D26"]
            blocked_by: ["task-5b.8-store-violations"]
            related_to: []
            acceptance_criteria:
              - "Violation details displayed"
              - "Dismiss action with optional reason"
              - "False positive checkbox"
              - "Auth required"
              - "Supports ?action= query param for deep linking"
          - id: "task-5b.15-evolution-review"
            title: "Build pattern evolution review page"
            description: |
              Review page for pattern owners to accept or reject evidence changes.
            type: "feature"
            priority: 0
            effort_hours: 6
            prd_refs: ["Task 5b.15", "D27"]
            blocked_by: ["task-5b.5-evolution-detect"]
            related_to: []
            acceptance_criteria:
              - "Diff summary displayed"
              - "Current pattern definition shown"
              - "Accept: update evidence, optionally update description"
              - "Reject: create violation"
          - id: "task-5b.16-evolution-lifecycle"
            title: "Handle PR merged/closed webhooks for evolution lifecycle"
            description: |
              Update pattern evolution request status based on PR lifecycle events.
            type: "task"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 5b.16", "D27"]
            blocked_by: ["task-5b.1-webhook-endpoint"]
            related_to: ["task-5b.5-evolution-detect", "task-5b.15-evolution-review"]
            acceptance_criteria:
              - "On PR merge: set pending evolution requests to status='historical', closedAt=now()"
              - "On PR closed without merge: set to status='cancelled', closedAt=now()"
              - "Only affects evolution requests for the specific PR"
  # ============================================
  # EPIC 6: POLISH
  # ============================================
  - id: "epic-polish"
    title: "Production-ready UX, error handling, and maintenance features"
    description: |
      Add error handling, retry logic, loading states, empty states, 
      re-extraction, impact digest, and auto-maintenance features.
    prd_refs: ["Section 6.2 Phase 6"]
    effort_days: 6
    stories:
      - id: "story-error-handling"
        title: "Comprehensive error handling and retry logic"
        description: |
          Handle errors gracefully across all jobs and UI states.
        prd_refs: ["Task 6.1a", "Task 6.1b", "Task 6.1c", "Task 6.1d", "Task 6.1e", "Task 6.1f", "Task 6.2"]
        effort_hours: 16
        acceptance_criteria:
          - "All failures captured with meaningful error messages"
          - "Retry logic with exponential backoff"
          - "UI shows failure states with retry buttons"
        tasks:
          - id: "task-6.1a-error-fields"
            title: "Add lastError field to Repo and PullRequest"
            description: |
              Store error messages for debugging failed operations.
            type: "task"
            priority: 0
            effort_hours: 1
            prd_refs: ["Task 6.1a"]
            blocked_by: ["task-1.6-core-schema"]
            related_to: []
            acceptance_criteria:
              - "lastError: string | null on Repo and PullRequest"
              - "Cleared on successful operation"
          - id: "task-6.1b-extraction-errors"
            title: "Extraction error handling with UI feedback"
            description: |
              Catch LLM API errors, set extractionStatus='failed', show retry button.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 6.1b"]
            blocked_by: ["task-3.4-extract-job"]
            related_to: []
            acceptance_criteria:
              - "LLM errors caught and logged"
              - "extractionStatus set to 'failed'"
              - "lastError populated with message"
              - "UI shows 'Extraction failed' with retry"
          - id: "task-6.1c-ingestion-errors"
            title: "Ingestion error handling with UI feedback"
            description: |
              Catch GitHub API errors, set ingestionStatus='failed', show retry.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 6.1c"]
            blocked_by: ["task-2.4-ingest-job"]
            related_to: []
            acceptance_criteria:
              - "GitHub errors caught and logged"
              - "ingestionStatus set to 'failed'"
              - "UI shows 'Ingestion failed' with retry"
          - id: "task-6.1d-pr-analysis-errors"
            title: "PR analysis error handling"
            description: |
              Catch errors during PR analysis, set analysisStatus='failed'.
            type: "task"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 6.1d"]
            blocked_by: ["task-5b.7-analyze-job"]
            related_to: []
            acceptance_criteria:
              - "Analysis errors caught"
              - "analysisStatus set to 'failed'"
              - "Status check shows 'Analysis failed — will retry'"
          - id: "task-6.1e-github-rate-limits"
            title: "GitHub rate limit handling with backoff"
            description: |
              Check X-RateLimit-Remaining, queue retry with exponential backoff.
            type: "task"
            priority: 0
            effort_hours: 3
            prd_refs: ["Task 6.1e"]
            blocked_by: ["task-2.1-repo-fetch"]
            related_to: []
            acceptance_criteria:
              - "Check rate limit headers on all GitHub calls"
              - "Back off when <100 remaining"
              - "Exponential backoff on 403 rate limit"
          - id: "task-6.1f-llm-rate-limits"
            title: "LLM rate limit handling with Trigger.dev retry"
            description: |
              Catch Anthropic 429 responses, queue retry with backoff.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 6.1f"]
            blocked_by: ["task-3.2-extraction-pipeline"]
            related_to: []
            acceptance_criteria:
              - "429 responses caught"
              - "Retry queued via Trigger.dev"
              - "Exponential backoff applied"
          - id: "task-6.2-retry-config"
            title: "Configure Trigger.dev job retry logic"
            description: |
              Set max attempts and exponential backoff for all jobs.
            type: "task"
            priority: 0
            effort_hours: 2
            prd_refs: ["Task 6.2"]
            blocked_by: ["task-6.1a-error-fields"]
            related_to: []
            acceptance_criteria:
              - "Max 3 attempts configured"
              - "Exponential backoff between attempts"
              - "Integrates with error handling tasks"
      - id: "story-ux-polish"
        title: "Loading states, empty states, and UX refinements"
        description: |
          Add polish for production-ready user experience.
        prd_refs: ["Task 6.3", "Task 6.4", "Task 6.6", "Task 6.8"]
        effort_hours: 10
        acceptance_criteria:
          - "Loading indicators for all async operations"
          - "Empty states for all list views"
          - "Pattern editing capabilities"
        tasks:
          - id: "task-6.3-loading-states"
            title: "Add loading states and progress indicators"
            description: |
              Loading spinners and progress indicators throughout the app.
            type: "task"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 6.3"]
            blocked_by: []
            related_to: []
            acceptance_criteria:
              - "Loading spinner for all data fetching"
              - "Progress indicator during extraction"
              - "Skeleton loaders for content areas"
          - id: "task-6.4-empty-states"
            title: "Add empty states for all views"
            description: |
              Helpful empty states when no data available.
            type: "task"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 6.4"]
            blocked_by: []
            related_to: []
            acceptance_criteria:
              - "Empty state for no patterns"
              - "Empty state for no violations"
              - "Empty state for no repos"
              - "Zero patterns extracted state"
          - id: "task-6.6-pattern-editing"
            title: "Enable pattern editing post-validation"
            description: |
              Allow editing description and rationale after promotion.
            type: "feature"
            priority: 2
            effort_hours: 3
            prd_refs: ["Task 6.6"]
            blocked_by: ["task-4.7-pattern-detail"]
            related_to: []
            acceptance_criteria:
              - "Edit button on pattern detail"
              - "Inline editing for description, rationale"
              - "Save button with confirmation"
          - id: "task-6.6a-storage-cleanup"
            title: "Cleanup pr_diffs storage on repo disconnect"
            description: |
              Delete stored PR diffs from Supabase Storage when user disconnects a repo.
            type: "task"
            priority: 2
            effort_hours: 2
            prd_refs: ["Task 6.6a", "D28"]
            blocked_by: ["task-1.8-installation-token"]
            related_to: ["task-2.10-pr-history", "task-6.8-settings-ui"]
            acceptance_criteria:
              - "On repo disconnect, delete pr_diffs/{repo_id}/ folder from Supabase Storage"
              - "Handle storage deletion errors gracefully"
              - "Log cleanup operations for auditing"
          - id: "task-6.8-settings-ui"
            title: "Basic settings UI"
            description: |
              Settings for notifications and repo management.
            type: "feature"
            priority: 2
            effort_hours: 3
            prd_refs: ["Task 6.8"]
            blocked_by: []
            related_to: []
            acceptance_criteria:
              - "Notification preferences (future: email)"
              - "Repo management (disconnect repo)"
              - "User profile"
      - id: "story-maintenance"
        title: "Re-extraction, auto-behaviors, and impact metrics"
        description: |
          Add maintenance features for ongoing pattern management.
        prd_refs: ["Task 6.5", "Task 6.5a", "Task 6.7", "Task 6.8a", "Task 6.9", "Task 6.10", "Task 6.11"]
        effort_hours: 20
        acceptance_criteria:
          - "Manual re-extraction with evidence re-capture"
          - "Weekly impact digest widget"
          - "Auto-archive for stale weak patterns"
          - "Deep linking through auth flow"
        tasks:
          - id: "task-6.5-re-extraction"
            title: "Implement re-extraction trigger"
            description: |
              Manual 're-analyze repo' button with proper handling of existing patterns.
            type: "feature"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 6.5", "D9"]
            blocked_by: ["task-3.4-extract-job", "task-6.5a-evidence-recapture"]
            related_to: []
            acceptance_criteria:
              - "Button triggers re-extraction"
              - "Candidate and deferred patterns deleted"
              - "Authoritative patterns preserved"
              - "Rejected patterns preserved"
              - "Backtest re-run after extraction"
          - id: "task-6.5a-evidence-recapture"
            title: "Evidence re-capture for authoritative patterns"
            description: |
              LLM re-analyzes evidence files to refresh line numbers and snippets.
            type: "task"
            priority: 0
            effort_hours: 4
            prd_refs: ["Task 6.5a"]
            blocked_by: ["task-3.2-extraction-pipeline"]
            related_to: []
            acceptance_criteria:
              - "Each evidence file re-analyzed"
              - "startLine, endLine, snippet updated"
              - "capturedAtSha updated to current HEAD"
              - "Missing patterns marked stale"
          - id: "task-6.7-impact-digest"
            title: "Build weekly impact digest dashboard widget"
            description: |
              Rolling 7-day window showing violations caught and time saved.
            type: "feature"
            priority: 1
            effort_hours: 4
            prd_refs: ["Task 6.7", "D12"]
            blocked_by: ["task-5b.8-store-violations"]
            related_to: []
            acceptance_criteria:
              - "Last 7 Days violations count"
              - "Time saved calculation (violations × 15 min)"
              - "Top 3 patterns by violation count"
              - "Aggregated across all user's repos"
          - id: "task-6.8a-evolution-badge"
            title: "Dashboard notification badge for pending evolution reviews"
            description: |
              Show badge count for pending PatternEvolutionRequests.
            type: "feature"
            priority: 2
            effort_hours: 2
            prd_refs: ["Task 6.8a", "D27"]
            blocked_by: ["task-5b.5-evolution-detect"]
            related_to: []
            acceptance_criteria:
              - "Badge count on nav"
              - "Realtime updates via Supabase"
              - "Links to evolution review page"
          - id: "task-6.9-logging"
            title: "Set up logging and observability"
            description: |
              Configure logging for debugging and monitoring.
            type: "task"
            priority: 2
            effort_hours: 2
            prd_refs: ["Task 6.9"]
            blocked_by: []
            related_to: []
            acceptance_criteria:
              - "Trigger.dev dashboard accessible"
              - "Supabase logs queryable"
              - "Key operations logged"
          - id: "task-6.10-auto-archive"
            title: "Implement daily auto-archive scheduled job"
            description: |
              Archive weak patterns unreviewed for 60 days.
            type: "task"
            priority: 1
            effort_hours: 3
            prd_refs: ["Task 6.10", "D18"]
            blocked_by: ["task-3.6-store-candidates"]
            related_to: []
            acceptance_criteria:
              - "Daily job scheduled at 03:00 UTC (low GitHub API usage window)"
              - "Weak patterns unreviewed for 60+ days auto-rejected"
              - "rejectionReason set to 'Auto-dismissed: insufficient evidence'"
              - "Job execution logged for monitoring"
          - id: "task-6.11-auth-deep-linking"
            title: "Implement auth flow deep linking with returnTo"
            description: |
              Preserve original URL through OAuth flow for seamless return.
            type: "task"
            priority: 1
            effort_hours: 2
            prd_refs: ["Task 6.11"]
            blocked_by: ["task-1.5-github-oauth"]
            related_to: []
            acceptance_criteria:
              - "returnTo URL stored in cookie/session"
              - "Redirect to original URL post-login"
              - "Works for violation dismissal from PR comments"
# ============================================
# DECISIONS (D1-D36)
# ============================================
decisions:
  - id: "D1"
    title: "Pattern as core abstraction"
    choice: "Patterns (semantic meaning) over files, services, or rules"
    rationale: "Patterns capture how organizations think about conventions"
    affects_tasks:
      - "task-1.6-core-schema"
      - "task-3.1-extraction-prompt"

  - id: "D2"
    title: "Three-agent model (Observer/Actor/Scout)"
    choice: "Graduated autonomy with Observer as MVP focus"
    rationale: "Match risk to capability; build trust incrementally"
    affects_tasks: []

  - id: "D3"
    title: "Provenance as primary moat"
    choice: "Decision history creates org-specific, defensible value"
    rationale: "Can't be replicated by general tools like Copilot"
    affects_tasks:
      - "task-4.5-rationale-field"
      - "task-4.6-provenance-linking"

  - id: "D4"
    title: "GitHub App auth model"
    choice: "GitHub App over OAuth for org-level integration"
    rationale: "Native webhooks, PR comments as app, status checks"
    affects_tasks:
      - "task-1.4-github-app-setup"
      - "task-1.5-github-oauth"
      - "task-1.7-installation-flow"

  - id: "D5"
    title: "Multi-repo support from day 1"
    choice: "repoId as first-class FK from the start"
    rationale: "Trivial to add now, painful to migrate later"
    affects_tasks:
      - "task-1.6-core-schema"

  - id: "D6"
    title: "Own database for pattern storage"
    choice: "Supabase Postgres over patterns-as-code in repo"
    rationale: "Provenance, querying, validation need real DB"
    affects_tasks:
      - "task-1.2-supabase-setup"
      - "task-1.6-core-schema"

  - id: "D7"
    title: "Tech stack: Supabase + Trigger.dev (superseded by D37)"
    choice: "Original: Supabase + Vercel + Trigger.dev"
    rationale: "See D37 for current stack (Hono + Vite + TanStack Router)"

  - id: "D37"
    title: "Framework migration: Hono + Vite + TanStack Router"
    choice: "Hono backend + Vite/React/TanStack Router frontend + tRPC"
    rationale: "Lightweight, edge-ready, faster dev, type-safe"
    affects_tasks:
      - "task-1.1-monorepo-init"
      - "task-1.2-supabase-setup"
      - "task-1.3-triggerdev-setup"

  - id: "D8"
    title: "Claude Sonnet 4.5 for all LLM tasks"
    choice: "Single model (claude-sonnet-4-5-20250929)"
    rationale: "Simplicity for MVP; strong code understanding"
    affects_tasks:
      - "task-3.2-extraction-pipeline"

  - id: "D9"
    title: "Extract-once with manual refresh"
    choice: "No incremental analysis for MVP"
    rationale: "Simplicity; re-extract on demand"
    affects_tasks:
      - "task-6.5-re-extraction"
      - "task-6.5a-evidence-recapture"

  - id: "D10"
    title: "Full-repo single-pass extraction with 1M context"
    choice: "600k token limit with safety buffer"
    rationale: "Single-pass preserves cross-file patterns"
    affects_tasks:
      - "task-2.12-token-count"
      - "task-3.4-extract-job"

  - id: "D11"
    title: "Multi-dimensional confidence scoring with health signals"
    choice: "4 dimensions (Evidence, Adoption, Establishment, Location) + 5 health categories"
    rationale: "Intentionality and significance matter more than frequency"
    affects_tasks:
      - "task-3.7-confidence-dimensions"
      - "task-3.9-health-signals"
      - "task-3.10-confidence-tier"
      - "task-4.1-confidence-card"

  - id: "D12"
    title: "Engagement loop features for validation stickiness"
    choice: "Backtest, attribution, queue UX, digest"
    rationale: "Immediate reward for validation actions"
    affects_tasks:
      - "task-4.9-backtest"
      - "task-4.10-impact-preview"
      - "task-4.11-queue-ux"
      - "task-6.7-impact-digest"
      - "task-5b.9-pr-comments"

  - id: "D13"
    title: "Pattern mental model and triage UX"
    choice: "Pattern = abstract definition; keyboard-first linear queue"
    rationale: "Respect senior engineer workflows; progressive disclosure"
    affects_tasks:
      - "task-4.1-confidence-card"
      - "task-4.11-queue-ux"

  - id: "D14"
    title: "Vision vs MVP documentation separation"
    choice: "Vision in Appendix E; 2.1-2.2 rewritten for MVP"
    rationale: "One source of truth for current build"
    affects_tasks: []

  - id: "D15"
    title: "GitHub token handling: on-demand generation"
    choice: "No database storage; @octokit/auth-app handles caching"
    rationale: "Simpler, more secure, follows GitHub patterns"
    affects_tasks:
      - "task-1.8-installation-token"
      - "task-1.9-env-config"

  - id: "D16"
    title: "Batch extraction results for MVP"
    choice: "All patterns appear at once; no streaming"
    rationale: "Simpler implementation; core value unchanged"
    affects_tasks:
      - "task-3.4-extract-job"
      - "task-4.12-repo-progress"

  - id: "D17"
    title: "Queue sorting algorithm"
    choice: "Tier buckets with backtest tie-breaking"
    rationale: "Tier for 'should enforce?', backtest for 'value if we do'"
    affects_tasks:
      - "task-4.8-pattern-dashboard"
      - "task-4.11-queue-ux"

  - id: "D18"
    title: "Rejection flow: optional reason modal"
    choice: "Optional text field; zero friction path available"
    rationale: "Fast for obvious rejections; signal when useful"
    affects_tasks:
      - "task-4.3-validation-actions"
      - "task-6.10-auto-archive"

  - id: "D19"
    title: "Violation severity: per-pattern default"
    choice: "Set during promotion; default to 'warning'"
    rationale: "User control; safe default that doesn't block"
    affects_tasks:
      - "task-4.4-promote-action"
      - "task-5b.8-store-violations"

  - id: "D20"
    title: "Consistency assessment: LLM-judged"
    choice: "Explicit rubric in extraction prompt"
    rationale: "LLM already analyzing; clear criteria ensure consistency"
    affects_tasks:
      - "task-3.8-consistency-assessment"

  - id: "D21"
    title: "Evidence management: autocomplete with staleness"
    choice: "File autocomplete; snapshot + staleness detection"
    rationale: "GitHub links always work; users see when outdated"
    affects_tasks:
      - "task-2.13-repo-files-table"
      - "task-2.14-stale-evidence-detection"
      - "task-4.13-evidence-management"

  - id: "D22"
    title: "Pattern ownership: validator becomes owner"
    choice: "Single person = owner = validator for MVP"
    rationale: "Simple; ownership transfer post-MVP"
    affects_tasks:
      - "task-4.4-promote-action"

  - id: "D23"
    title: "Health signals: single prompt with smart deprecation"
    choice: "One prompt per pattern covering all 5 categories"
    rationale: "Cost-effective; LLM knowledge for deprecation"
    affects_tasks:
      - "task-3.9-health-signals"

  - id: "D24"
    title: "Insight rules: json-rules-engine"
    choice: "15 starter rules with priority ordering"
    rationale: "Declarative, modifiable, future-proofs for customization"
    affects_tasks:
      - "task-3.11-insight-generation"

  - id: "D25"
    title: "Location classification: LLM-based"
    choice: "7 code categories classified by content, not path"
    rationale: "More accurate across diverse codebases"
    affects_tasks:
      - "task-3.7-confidence-dimensions"

  - id: "D26"
    title: "Violation dismissal: single action"
    choice: "Dismiss with optional FP checkbox"
    rationale: "One action; captures false positive signal"
    affects_tasks:
      - "task-5b.14-violation-detail"

  - id: "D27"
    title: "Pattern evolution: detect and require review"
    choice: "Detect evidence modifications; owner decides"
    rationale: "Prevents silent drift; enables legitimate evolution"
    affects_tasks:
      - "task-5b.5-evolution-detect"
      - "task-5b.6-diff-summary"
      - "task-5b.10-evolution-comments"
      - "task-5b.12-evolution-status"
      - "task-5b.15-evolution-review"
      - "task-5b.16-evolution-lifecycle"

  - id: "D28"
    title: "Backtest diff storage"
    choice: "Supabase Storage for PR diffs"
    rationale: "Fast backtest; no API calls during analysis"
    affects_tasks:
      - "task-2.10-pr-history"
      - "task-4.9-backtest"
      - "task-6.6a-storage-cleanup"

  - id: "D29"
    title: "Duplicate detection with merge"
    choice: "LLM similarity check; one-click merge action"
    rationale: "Efficient evidence capture during re-extraction"
    affects_tasks:
      - "task-3.15-similarity-detection"
      - "task-4.14-merge-action"

  - id: "D30"
    title: "Dual channel enforcement"
    choice: "PR review + AI context as separate toggles"
    rationale: "Cover both AI-assisted and manual contributors"
    affects_tasks:
      - "task-4.16-enforcement-toggles"
      - "task-5a.3-pattern-transformer"
      - "task-5b.3-code-violation"

  - id: "D31"
    title: "Filesystem patterns as first-class type"
    choice: "file-naming and file-structure; boundaries deferred"
    rationale: "AI agents need filesystem guidance"
    affects_tasks:
      - "task-3.16-filesystem-tree"
      - "task-3.17-filesystem-prompt"
      - "task-3.18-filesystem-evidence"

  - id: "D32"
    title: "Context file formats: Claude + Cursor"
    choice: "Two formats for MVP; add more post-MVP"
    rationale: "Dominant AI coding tools; ~1 day per additional format"
    affects_tasks:
      - "task-5a.1-context-config"
      - "task-5a.4-format-adapters"

  - id: "D33"
    title: "Marker-based context file append"
    choice: "Manage only between markers; preserve user content"
    rationale: "Zero setup; never destroys user content"
    affects_tasks:
      - "task-5a.6-marker-append"

  - id: "D34"
    title: "Simplified confidence for filesystem patterns"
    choice: "2 dimensions (Evidence + Adoption) only"
    rationale: "Establishment and Location don't translate"
    affects_tasks:
      - "task-3.19-filesystem-confidence"
      - "task-4.15-filesystem-card"

  - id: "D35"
    title: "File-structure patterns: context-file-only"
    choice: "No PR enforcement for structure patterns"
    rationale: "Ambiguous whether incomplete or work-in-progress"
    affects_tasks:
      - "task-4.17-disable-structure-pr"
      - "task-5b.4-file-naming-violation"

  - id: "D36"
    title: "Debounced context file regeneration"
    choice: "5-10s debounce window"
    rationale: "Batch rapid changes; efficient resource usage"
    affects_tasks:
      - "task-5a.7-debounced-sync"

# ============================================
# OPEN QUESTIONS → SPIKE TASKS
# ============================================
open_questions:
  - id: "Q2"
    question: "Can we achieve <15min time-to-value?"
    status: "needs-spike"
    spike_task: "task-spike-time-to-value"
    affects_tasks:
      - "task-3.4-extract-job"

  - id: "Q4"
    question: "What's real LLM cost at scale? (100/500/1000-service scenarios)"
    status: "deferred"
    spike_task: null
    affects_tasks: []

  - id: "Q5"
    question: "How handle multi-repo orgs? Cross-repo patterns?"
    status: "deferred"
    spike_task: null
    affects_tasks: []

  - id: "Q6"
    question: "What's Copilot's trajectory?"
    status: "deferred"
    spike_task: null
    affects_tasks: []

  - id: "Q7"
    question: "Enterprise security requirements? SOC2, on-prem, data residency"
    status: "deferred"
    spike_task: null
    affects_tasks: []

  - id: "Q8"
    question: "International expansion? Language, pricing, compliance"
    status: "deferred"
    spike_task: null
    affects_tasks: []

# ============================================
# RISKS
# ============================================
risks:
  - id: "R1"
    description: "Extraction quality insufficient — LLMs fail to identify patterns with >80% precision"
    likelihood: "medium"
    impact: "critical"
    mitigation: "Iterative prompt engineering; confidence scoring surfaces uncertain extractions; accept lower precision if recall high"
    detection: "M5 (Extraction Quality Baseline) — measure precision. Kill threshold: <60%"
    contingency_tasks:
      - "task-3.1-extraction-prompt"
      - "task-3.2-extraction-pipeline"

  - id: "R2"
    description: "Violation detection is noisy — high false positive rate (>10%) on PR comments"
    likelihood: "medium"
    impact: "high"
    mitigation: "Conservative thresholds; severity tiers; dismiss action; shadow mode option"
    detection: "Track dismiss rate per pattern. >20% dismisses = pattern review"
    contingency_tasks:
      - "task-3.13-violation-module"
      - "task-5b.3-code-violation"

  - id: "R3"
    description: "Context window blocks target repos — more repos exceed 800k token limit than expected"
    likelihood: "low"
    impact: "medium"
    mitigation: "Target 50-200 files explicitly; clear error message; subdirectory workaround"
    detection: "Track % of connection attempts blocked. >10% = prioritize chunking"
    contingency_tasks:
      - "task-2.12-token-count"

  - id: "R4"
    description: "Time-to-value too slow — takes >15 minutes to see useful patterns"
    likelihood: "medium"
    impact: "high"
    mitigation: "Async extraction with file tree immediately; progress indicators; fast confidence scoring"
    detection: "M12 (Time-to-Value Measured) — target <15 min"
    contingency_tasks:
      - "task-3.4-extract-job"
      - "task-4.12-repo-progress"

  - id: "R5"
    description: "Candidate queue ignored — users don't engage with pattern candidates"
    likelihood: "medium"
    impact: "high"
    mitigation: "Impact preview (backtest); queue depletion UX; confidence tiers; weekly digest"
    detection: "Track candidate → action rate. <30% in 14 days = problem"
    contingency_tasks:
      - "task-4.9-backtest"
      - "task-4.11-queue-ux"

  - id: "R6"
    description: "Provenance feels like busywork — users skip rationale"
    likelihood: "medium"
    impact: "high"
    mitigation: "Violation attribution shows rationale in PR; track completion rate; pre-fill suggestions"
    detection: "Track % of promoted patterns with rationale. <50% = UX problem"
    contingency_tasks:
      - "task-4.5-rationale-field"
      - "task-5b.9-pr-comments"

  - id: "R7"
    description: "GitHub ships pattern enforcement — Copilot or native adds architectural awareness"
    likelihood: "medium"
    impact: "critical"
    mitigation: "Provenance moat; move fast; monitor announcements; differentiate on depth"
    detection: "GitHub announcements, Copilot changelog, developer Twitter"
    contingency_tasks: []

  - id: "R8"
    description: "Solo founder bottleneck — unexpected complexity or scope creep derails timeline"
    likelihood: "medium"
    impact: "high"
    mitigation: "Critical path documented; milestones with go/no-go; AI-assisted dev; scope already cut"
    detection: "Weekly progress check. 2+ weeks behind = reassess scope"
    contingency_tasks: []

  - id: "R9"
    description: "Filesystem pattern extraction unreliable — high false positive rate"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Conservative extraction; 2-dimension confidence; allow human definition"
    detection: "Track promotion rate vs code patterns"
    contingency_tasks:
      - "task-3.17-filesystem-prompt"

  - id: "R10"
    description: "Context file user content conflicts — users edit inside markers"
    likelihood: "low"
    impact: "low"
    mitigation: "Clear markers with warning; UI warning on external modification"
    detection: "Support tickets about 'lost content'"
    contingency_tasks:
      - "task-5a.6-marker-append"
